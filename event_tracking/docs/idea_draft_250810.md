                                +------------------------------------+
                                |         SaaS Tenant Portal        |
                                +----------------+-------------------+
                                                 |
                                      +----------v-----------+
                                      |   API Gateway Layer   |
                                      +----+--------+--------+
                                           |        |
        +----------------------------------+        +-------------------------------+
        |                                                                               |

+-------v--------+ +------------v------------+
| Tracking Service |<-- JS SDK、Mobile SDK | Workflow Orchestrator |
+--------+--------+ +------------+------------+
| |
v v
+--------v--------+ +-----------------------+ +----------------------+ +---------------+
| Event Preprocessor| -->| Customer Data Platform |<-->| CRM Service |--> | AI Agent |
+--------+--------+ +-----------------------+ +----------------------+ +---------------+
| |
v |
+--------v----------------+ |
| Global Behavior DB | <------+
| (Anonymized Event DB) |
+--------+----------------+
|
v
+-----------------------------+
| Global Behavior Analyzer | <-- 全租戶匿名事件建模 / 聚類 / 行為關聯分析
| - Profile Pattern Mining |
| - 行為聚類 (Clustering) |
| - 對應觸發策略抽取 |
+-----------------------------+
|
v
+-----------------------------+
| Recommendation Engine | <-- 提供租戶可用建議，不可回查原資料
| - 最佳文案模板建議 |
| - 行銷推播時間預測建議 |
| - 分群推薦策略 |
+-----------------------------+
|
v
+------------------------------+
| Tenant-specific AI API |
| /v1/insights/recommendation |
+------------------------------+

┌──────────────────────────────┐
│ API Gateway / BFF │ (Auth + API Routing)
└────────────┬────────────────┘
│
┌────────▼────────┐
│ Authentication │──┐ <— 登入、Token 管理、OAuth、租戶認證
└─────────────────┘ │
│
┌────────────────────▼────────────────────┐
│ Core Services │
└────────────────────┬────────────────────┘
│
┌─────────────────┼────────────────┐
▼ ▼ ▼
┌────────────┐ ┌─────────────┐ ┌────────────────┐
│ Tenant │ │ Event │ │ Profile │
│ Management │ │ Collector │ │ Service │
└────────────┘ └─────────────┘ └────────────────┘
租戶管理 接收前端 SDK 資料 建立用戶行為與屬性關聯

       ┌────────────────────────────────┐
       ▼                                ▼

┌────────────────┐ ┌──────────────────┐
│ Identity Graph │ │ Consent Manager │
│ 服務間用戶關聯 │ │ 同意條款與資料授權 │
└────────────────┘ └──────────────────┘

       ┌─────────────────────────────────────┐
       ▼                                     ▼

┌──────────────────────┐ ┌─────────────────────────┐
│ Behavior Analytics │ │ Recommendation Engine │
│ 即時/批次行為分析 │ │ 行為模型 + 推薦模型 │
└──────────────────────┘ └─────────────────────────┘

       ┌─────────────────────────────┐
       ▼                             ▼

┌──────────────────────┐ ┌─────────────────────┐
│ Notification Service │ │ Audit & Compliance │
│ 推播/Email 通知服務 │ │ 記錄資料取用/模型紀錄 │
└──────────────────────┘ └─────────────────────┘

| 微服務名稱                    | 描述與責任                                                          | 資料依賴 / 輸出                |
| ----------------------------- | ------------------------------------------------------------------- | ------------------------------ |
| **API Gateway / BFF**         | 對外統一入口，處理 API 路由、Token 驗證、租戶識別、CORS、速率限制   | 所有外部服務與 SDK             |
| **Authentication Service**    | 負責租戶與用戶身份驗證，支援 OAuth2/JWT，SSO                        | Token、User Session、Tenant ID |
| **Tenant Management Service** | 建立租戶、模組設定、資料儲存區隔（Postgres Schema / DB per Tenant） | 租戶設定、配額、啟用模組       |
| **Event Collector Service**   | 接收 SDK 傳入的事件，Kafka 儲存至 ClickHouse/Redis 供即時/離線分析  | 行為資料流入 Kafka/ClickHouse  |
| **Profile Service**           | 建立與更新用戶屬性、標籤、屬性分群（年齡/性別/偏好等）              | 提供推薦、分析服務使用         |
| **Identity Graph Service**    | 建立跨設備、跨租戶的匿名 ID → 使用者識別映射圖（經合法授權）        | 建立/查詢跨租戶行為關聯        |
| **Consent Manager**           | 管理終端用戶對資料追蹤與分析的同意狀態（Cookie Consent、GDPR 項目） | 授權紀錄、封鎖非授權資料       |
| **Behavior Analytics**        | 即時處理：Flink/ClickHouse 查詢、使用者轉換/留存分析                | 提供 dashboard、供推薦引擎使用 |
| **Recommendation Engine**     | 使用行為模型（內容、協同過濾、Hybrid）推論商品、文章、內容推薦      | 推薦結果回傳 API/BFF           |
| **Notification Service**      | 根據事件規則或推薦結果發送通知（email/push）                        | 使用通知模板、排程推播         |
| **Audit & Compliance**        | 記錄所有用戶資料使用紀錄與模型訓練日誌，以符合法規要求              | 生成稽核報表、模型 trace log   |

┌────────────────────────────────────────────────────────────────────┐
│ 行為智能平台模組化架構設計 │
├────────────────────────────────────────────────────────────────────┤
│ ✅ 核心基礎模組 │
│ │
│ [A1] 行為事件接收模組 (Tracking API / SDK) │
│ [A2] 多租戶權限/資料隔離模組 │
│ [A3] 資料處理管線模組 (Kafka + NiFi) │
│ [A4] ClickHouse 資料儲存與分析模組 │
│ [A5] 行為模型定義與事件管理模組 (Behavior Definition & Meta Config) │
│ [A6] 身份整合模組 (匿名與已登入帳戶識別整合) │
├────────────────────────────────────────────────────────────────────┤
│ 🔍 資料分析/建模/推薦模組 │
│ │
│ [B1] 行為分群引擎（User Segmentation Engine） │
│ [B2] 行為序列圖譜分析模組（Path/Sequence Analysis） │
│ [B3] 行為關聯挖掘模組（Cross-Tenant Insight Layer） │
│ [B4] 即時規則式觸發模組（Real-time Trigger Engine） │
│ [B5] 智能推薦模組（Recommendation Engine with Privacy Filter） │
│ [B6] 自訂洞察報表模組（Insight Builder + Query DSL） │
├────────────────────────────────────────────────────────────────────┤
│ 💡 智能應用模組（可搭配上層行銷/運營平台） │
│ │
│ [C1] 行銷活動自動化模組（例如 EDM, LINE, Webhook 推送） │
│ [C2] 商品推薦模組（客製化商品頁排序、動態版位） │
│ [C3] 內容推薦模組（根據瀏覽與行為呈現不同內容） │
│ [C4] 顧客生命週期預測模組（LTV, 流失風險, 活躍預測） │
│ [C5] 跨租戶洞察模組（Privacy-safe insight aggregator） │
├────────────────────────────────────────────────────────────────────┤
│ 🔐 法規合規與控制模組 │
│ │
│ [D1] 資料可攜與刪除接口（Right to be Forgotten & Portability） │
│ [D2] 身份匿名化/偽名化機制（Pseudonymization/Anonymization） │
│ [D3] 模型與推薦使用限制設定（租戶資料不得被外部模型訓練） │
└────────────────────────────────────────────────────────────────────┘

| 解決方案名稱                         | 適用情境            | 包含模組                                | 特點                                                       |
| ------------------------------------ | ------------------- | --------------------------------------- | ---------------------------------------------------------- |
| 🎯 **行銷活動自動化套件**            | 電商、SaaS 用戶經營 | A1\~A6 + B1, B4 + C1                    | 實現根據用戶行為自動推送 LINE/Email 通知，並支援條件式分眾 |
| 🛍️ **智慧商品推薦套件**              | 電商平台            | A1\~A6 + B1, B5 + C2                    | 依瀏覽紀錄、購買紀錄推薦商品，支援動態展示排序             |
| 📈 **顧客洞察與預測分析套件**        | 經營/成長團隊       | A1~~A6 + B1~~B3 + C4                    | 預測活躍度、顧客流失、分析用戶生命週期與價值               |
| 🤝 **跨租戶行為洞察套件**            | B2B SaaS、平台商    | A1~~A6 + B3 + C5 + D1~~D3               | 在合法範圍內分析租戶間用戶行為，發現共通需求與建議解決方案 |
| 🧠 **AI 模型自主學習模組**（加值版） | 高階平台用戶        | 上述所有 + 專屬模型訓練框架（隔離租戶） | 允許租戶自行定義模型、上傳資料自訓練，並套用於推薦模組中   |
